<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Daily Expense Monitor | Transactions</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- App CSS -->
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="logo">â‚¹</div>
  <nav class="mt-4">
    <a href="index.html">Dashboard</a>
    <a href="transactions.html"><b>Transactions</b></a>
    <a href="reports.html">Reports</a>
    <a href="settings.html">Settings</a>
  </nav>
</div>

<!-- Topbar -->
<header class="topbar">
  <div class="topbar-inner">
    <h5 class="topbar-title">Transactions</h5>

    <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);display:flex;gap:14px;align-items:center;">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="darkToggle">
      </div>
      <div class="dropdown">
        <a href="#" data-bs-toggle="dropdown">
          <img id="profileImg" class="profile-img" src="https://via.placeholder.com/42">
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#profilePicModal">Change Picture</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" onclick="resetAllData()">Reset Data</a></li>
        </ul>
      </div>
    </div>
  </div>
</header>

<!-- Content -->
<main class="content">

  <!-- Add Transaction -->
  <div class="box mb-3">
    <h6>Add Transaction</h6>
    <div class="row g-2">
      <div class="col-md-2">
        <select id="type" class="form-control">
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
      </div>
      <div class="col-md-2">
        <input id="amount" type="number" class="form-control" placeholder="Amount">
      </div>
      <div class="col-md-3">
        <input id="category" class="form-control" placeholder="Category">
      </div>
      <div class="col-md-3">
        <input id="date" type="date" class="form-control">
      </div>
      <div class="col-md-2 d-grid">
        <button class="btn btn-primary" onclick="addTransaction()">Add</button>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="box">
    <h6>All Transactions</h6>
    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>#</th><th>Date</th><th>Type</th><th>Category</th><th class="text-end">Amount</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</main>

<!-- Edit Modal -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h6>Edit Transaction</h6></div>
      <div class="modal-body">
        <input type="hidden" id="editId">
        <input id="editAmount" class="form-control mb-2" placeholder="Amount">
        <input id="editCategory" class="form-control mb-2" placeholder="Category">
        <input id="editDate" type="date" class="form-control">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Profile Picture Modal -->
<div class="modal fade" id="profilePicModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h6>Profile Picture</h6></div>
      <div class="modal-body">
        <input type="file" id="profilePicInput" class="form-control">
        <div id="profilePicStatus" class="small mt-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="saveProfilePicBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Common -->
<script src="js/common.js"></script>

<!-- Transactions JS -->
<script>
const API = "http://127.0.0.1:5000/api";
const cur = getCurrency();
let allData = [];

async function loadTable() {
  const res = await fetch(API + "/transactions");
  allData = await res.json();
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  allData.forEach((t, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${t.date}</td>
        <td>${t.type}</td>
        <td>${t.category}</td>
        <td class="text-end">${cur}${t.amount}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="openEdit(${i})">Edit</button>
          <button class="btn btn-sm btn-outline-danger" onclick="del(${t.id})">Delete</button>
        </td>
      </tr>`;
  });
}

async function addTransaction() {
  await fetch(API + "/transactions", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      type: type.value,
      amount: Number(amount.value),
      category: category.value,
      date: date.value
    })
  });
  loadTable();
}

function openEdit(i) {
  const t = allData[i];
  editId.value = t.id;
  editAmount.value = t.amount;
  editCategory.value = t.category;
  editDate.value = t.date;
  new bootstrap.Modal(editModal).show();
}

async function saveEdit() {
  await fetch(API + "/transactions/" + editId.value, {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      amount: Number(editAmount.value),
      category: editCategory.value,
      date: editDate.value
    })
  });
  bootstrap.Modal.getInstance(editModal).hide();
  loadTable();
}

async function del(id) {
  if (!confirm("Delete transaction?")) return;
  await fetch(API + "/transactions/" + id, { method: "DELETE" });
  loadTable();
}

date.value = new Date().toISOString().slice(0,10);
loadTable();
</script>

</body>
</html>
